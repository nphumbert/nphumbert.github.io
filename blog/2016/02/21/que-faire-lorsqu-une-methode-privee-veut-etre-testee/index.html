<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Que faire lorsqu'une méthode privée veut être testée ?</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Entrepreneur, consultant, bio-sciences and software engineer."><meta name=author content="Nadia Humbert-Labeaumaz"><meta name=generator content="Hugo 0.131.0"><meta property="og:image" content="https://nphumbert.github.io/images/blog/testing-private-method/header.jpg"><meta property="og:url" content="https://nphumbert.github.io/blog/2016/02/21/que-faire-lorsqu-une-methode-privee-veut-etre-testee/"><meta property="og:site_name" content="Nadia Humbert-Labeaumaz"><meta property="og:title" content="Que faire lorsqu'une méthode privée veut être testée ?"><meta property="og:description" content="Les tests automatisés servent à vérifier le bon comportement d’un objet (ou d’un ensemble d’objets), indépendamment de la manière dont ce comportement est implémenté. Le comportement d’un objet est décrit par son API publique (constructeurs, constantes et méthodes publiques). Les tests ne devraient donc utiliser que cette API.
Les méthodes privées (et protected) ne faisant pas partie de l’API publique d’un objet, elles ne devraient pas être appelées directement par le code de test.
Cet article a pour objectif de montrer comment réagir lorsqu’il paraît nécessaire de tester une méthode privée."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2016-02-21T11:09:38+01:00"><meta property="article:modified_time" content="2016-02-21T11:09:38+01:00"><meta property="article:tag" content="Software Testing"><meta property="article:tag" content="Software Design"><meta property="og:image" content="https://nphumbert.github.io/images/slider.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nphumbert.github.io/images/slider.jpg"><meta name=twitter:title content="Que faire lorsqu'une méthode privée veut être testée ?"><meta name=twitter:description content="Les tests automatisés servent à vérifier le bon comportement d’un objet (ou d’un ensemble d’objets), indépendamment de la manière dont ce comportement est implémenté. Le comportement d’un objet est décrit par son API publique (constructeurs, constantes et méthodes publiques). Les tests ne devraient donc utiliser que cette API.
Les méthodes privées (et protected) ne faisant pas partie de l’API publique d’un objet, elles ne devraient pas être appelées directement par le code de test.
Cet article a pour objectif de montrer comment réagir lorsqu’il paraît nécessaire de tester une méthode privée."><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDXGPB3FE3"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FDXGPB3FE3")}</script><link rel=stylesheet href=/plugins/bootstrap/css/bootstrap.min.css media=screen><link rel=stylesheet href=/plugins/ionicons/css/ionicons.min.css><link rel=stylesheet href=/plugins/magnific-popup/magnific-popup.min.css><link rel=stylesheet href=/plugins/slick/slick.css><link rel=stylesheet href=/scss/style.min.css media=screen><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=icon href=/images/favicon.png type=image/x-icon><link rel=canonical href=https://nphumbert.github.io/blog/2016/02/21/que-faire-lorsqu-une-methode-privee-veut-etre-testee/></head><body><div class=preloader></div><header class=navigation><div class=container><div class=row><div class=col-md-12><nav class=navbar><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navigation>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse" id=navigation><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Articles</a></li></ul></div></nav></div></div></div></header><section class="page-title bg-2" style=background-image:url(/images/blog/testing-private-method/header.jpg)><div class=container><div class=row><div class=col-md-12><div class=block><h1>Que faire lorsqu'une méthode privée veut être testée ?</h1><p></p></div></div></div></div></section><section class=page-wrapper><div class=container><div class=row><div class=col-md-8><div class="post post-single"><h2 class=post-title>Que faire lorsqu'une méthode privée veut être testée ?</h2><div class=post-meta><ul><li><i class=ion-calendar></i> February 21, 2016</li><li><i class=ion-android-people></i>
Posted by
<a class=text-primary href=/author/nadia-humbert-labeaumaz>Nadia Humbert-Labeaumaz</a></li><li><i class=ion-pricetags></i>
<a href=/tags/software-testing>Software Testing</a>, <a href=/tags/software-design>Software Design</a></li></ul></div><div class=post-thumb><img class=img-responsive src=/images/blog/testing-private-method/header.jpg alt="Que faire lorsqu'une méthode privée veut être testée ?"></div><div class="post-content post-excerpt"><p>Les tests automatisés servent à vérifier le bon comportement d&rsquo;un objet (ou d&rsquo;un ensemble d&rsquo;objets), indépendamment de la manière dont ce comportement est implémenté. Le comportement d&rsquo;un objet est décrit par son API publique (constructeurs, constantes et méthodes publiques). Les tests ne devraient donc utiliser que cette API.</p><p>Les méthodes privées (et <em>protected</em>) ne faisant pas partie de l&rsquo;API publique d&rsquo;un objet, elles ne devraient pas être appelées directement par le code de test.</p><p>Cet article a pour objectif de montrer comment réagir lorsqu&rsquo;il paraît nécessaire de tester une méthode privée.</p><h2 id=contexte>Contexte</h2><p>Un projet d&rsquo;illustration a été créé afin de servir de support pour cet article. Il est disponible sur <a href=https://github.com/nphumbert/demo-private-method-test/>GitHub</a>.</p><p>Il s&rsquo;agit de hasher le mot de passe lors de la création d&rsquo;un utilisateur. Il faut imaginer que la méthode de hash est plus complexe (utilisation de librairies externes, de nombreuses conditions, etc.) pour donner tout son sens à la suite de l&rsquo;article.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String login;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String email;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String password;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>User</span>(String login, String email, String password) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> login;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> email;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> hash(password);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>hash</span>(String password) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            MessageDigest md <span style=color:#f92672>=</span> MessageDigest.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;SHA-256&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Arrays.<span style=color:#a6e22e>toString</span>(md.<span style=color:#a6e22e>digest</span>(password.<span style=color:#a6e22e>getBytes</span>(<span style=color:#e6db74>&#34;UTF-8&#34;</span>)));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (NoSuchAlgorithmException <span style=color:#f92672>|</span> IOException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>La méthode de hash étant considérée comme complexe, le besoin se fait sentir de tester son code en isolation. En effet, en partant de cette hypothèse, il n&rsquo;est pas facilement possible de le tester complètement en utilisant uniquement des appels à l&rsquo;API publique.</p><h2 id=eviter-la-réflexion>Eviter la réflexion</h2><p>Parfois, la réflexion est utilisée pour augmenter la visibilité de la méthode privée durant la durée d&rsquo;un test. Cette méthode peut alors être appelée directement.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_hash_password</span>() <span style=color:#66d9ef>throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// given</span>
</span></span><span style=display:flex><span>    User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User(<span style=color:#e6db74>&#34;jdoe&#34;</span>, <span style=color:#e6db74>&#34;john.doe@gmail.com&#34;</span>, <span style=color:#e6db74>&#34;secret&#34;</span>);
</span></span><span style=display:flex><span>    Method method <span style=color:#f92672>=</span> user.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getDeclaredMethod</span>(<span style=color:#e6db74>&#34;hash&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    method.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// when</span>
</span></span><span style=display:flex><span>    String hashedPassword <span style=color:#f92672>=</span> (String) method.<span style=color:#a6e22e>invoke</span>(user, <span style=color:#e6db74>&#34;secret&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// then</span>
</span></span><span style=display:flex><span>    assertThat(hashedPassword, is(<span style=color:#e6db74>&#34;[43, -72, 13, 83, 123, 29, -93, -29, -117, -45, 3, 97, -86, -123, 86, -122, -67, -32, -22, -51, 113, 98, -2, -10, -94, 95, -23, 123, -11, 39, -94, 91]&#34;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Utiliser la réflexion dans ce cadre est dangereux !</p><p>En effet, toutes les actions ci-dessous auront pour effet de faire échouer le test, sans empêcher celui-ci de compiler :</p><ul><li>Renommer la méthode <code>hash</code>.</li><li>Changer l&rsquo;ordre ou le type des attributs de la méthode <code>hash</code>.</li><li>Changer le type de retour de la méthode <code>hash</code>.</li><li>Supprimer la méthode <code>hash</code> en intégrant son code dans une autre méthode (ou dans le constructeur).</li></ul><p>Toutes ces actions sont des décisions d&rsquo;implémentation qui n&rsquo;ont aucun lien avec le comportement de la classe. Il n&rsquo;est donc pas normal qu&rsquo;un test échoue lorsque l&rsquo;une de ces actions est effectuée.</p><p>Par ailleurs, l&rsquo;API de réflexion Java manipulant des <code>String</code> et des <code>Object</code>, l&rsquo;IDE n&rsquo;est pas capable d&rsquo;aider à corriger automatiquement le code de test correspondant.</p><h2 id=déplacer-le-code-dans-une-dépendance-externe>Déplacer le code dans une dépendance externe</h2><p>Selon moi, la meilleure manière de réagir est d&rsquo;extraire le code, qui doit être testé, dans sa propre classe.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>HashProvider</span> {
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>hash</span>(String value);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sha256HashProvider</span> <span style=color:#66d9ef>implements</span> HashProvider {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>hash</span>(String value) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            MessageDigest md <span style=color:#f92672>=</span> MessageDigest.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;SHA-256&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Arrays.<span style=color:#a6e22e>toString</span>(md.<span style=color:#a6e22e>digest</span>(value.<span style=color:#a6e22e>getBytes</span>(<span style=color:#e6db74>&#34;UTF-8&#34;</span>)));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (NoSuchAlgorithmException <span style=color:#f92672>|</span> IOException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>La classe <code>User</code> de l&rsquo;exemple est alors transformée comme ci-dessous.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String login;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String email;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String password;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>User</span>(String login, String email, String password, HashProvider hashProvider) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> login;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> email;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> hashProvider.<span style=color:#a6e22e>hash</span>(password);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Par ailleurs, le test se trouve également modifié.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_hash_password_when_create_user</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// given</span>
</span></span><span style=display:flex><span>    HashProvider hashProvider <span style=color:#f92672>=</span> mock(HashProvider.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    when(hashProvider.<span style=color:#a6e22e>hash</span>(<span style=color:#e6db74>&#34;secret&#34;</span>)).<span style=color:#a6e22e>thenReturn</span>(<span style=color:#e6db74>&#34;hash&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// when</span>
</span></span><span style=display:flex><span>    User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User(<span style=color:#e6db74>&#34;jdoe&#34;</span>, <span style=color:#e6db74>&#34;john.doe@gmail.com&#34;</span>, <span style=color:#e6db74>&#34;secret&#34;</span>, hashProvider);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// then</span>
</span></span><span style=display:flex><span>    assertThat(user.<span style=color:#a6e22e>password</span>(), is(<span style=color:#e6db74>&#34;hash&#34;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Le code respecte désormais le <a href=https://en.wikipedia.org/wiki/Single_responsibility_principle><em>Single Responsibility Principle</em> (SRP)</a>. En effet, chaque classe ne fait qu&rsquo;une seule chose. Il n&rsquo;est donc, par exemple, plus nécessaire de modifier la classe <code>User</code> pour changer la logique de hashage.</p><p>Le <a href=https://en.wikipedia.org/wiki/Open/closed_principle><em>Open/Closed Principle</em> (OCP)</a> est aussi mis en application car la classe <code>User</code> ne se préoccupe pas de l&rsquo;implémentation de <code>HashProvider</code> qu&rsquo;elle utilise. Il est donc possible de la changer sans que le code de <code>User</code> en soit affecté.</p><p>Tout le code est complètement testé en utilisant seulement les API publiques. Cela signifie que seul le comportement est testé, et non plus l&rsquo;implémentation.</p><p>Finalement, le code de production ainsi que celui de test est simplifié.</p><h2 id=conclusion>Conclusion</h2><p>Lorsqu&rsquo;une méthode privée devient si complexe que le besoin de la tester en isolation se fait sentir, cela signifie que la classe fait trop de choses et que le SRP n&rsquo;est sûrement pas respecté. Extraire cette méthode dans une classe externe permet de tester complètement ce code tout en améliorant le design en rendant le code plus SOLID.</p><p>Dès qu&rsquo;une méthode privée est créée afin d&rsquo;effectuer un traitement, il peut être utile de se demander si elle ne devrait pas être extraite, tout en restant pragmatique.</p></div><div class=post-comments></div></div></div><div class=col-md-4><aside class=sidebar><div class="widget widget-latest-post"><h4 class=widget-title>Latest Posts</h4><div class=media><a class=pull-left href=/blog/2021/04/28/effecting-long-lasting-changes/><img class=media-object src=/images/blog/effecting-long-lasting-changes/header.jpg alt="How to Effect Long-Lasting Organisational Changes"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/04/28/effecting-long-lasting-changes/>How to Effect Long-Lasting Organisational Changes</a></h4></div></div><div class=media><a class=pull-left href=/blog/2021/01/14/what-is-a-social-entrepreneur/><img class=media-object src=/images/blog/what-is-a-social-entrepreneur/header.jpg alt="What is a Social Entrepreneur?"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/01/14/what-is-a-social-entrepreneur/>What is a Social Entrepreneur?</a></h4></div></div><div class=media><a class=pull-left href=/blog/2020/07/05/debt-sme-nz/><img class=media-object src=/images/blog/debt-sme-nz/header.jpg alt="Debt and SMEs in New Zealand"></a><div class=media-body><h4 class=media-heading><a href=/blog/2020/07/05/debt-sme-nz/>Debt and SMEs in New Zealand</a></h4></div></div><div class=media><a class=pull-left href=/blog/2019/06/27/cloudy-relationship-france-diesel/><img class=media-object src=/images/blog/diesel/header.jpg alt="The Cloudy Relationship Between France and Diesel"></a><div class=media-body><h4 class=media-heading><a href=/blog/2019/06/27/cloudy-relationship-france-diesel/>The Cloudy Relationship Between France and Diesel</a></h4></div></div></div><div class="widget widget-category"><h4 class=widget-title>Categories</h4><ul class=widget-category-list><li><a href=/categories/business/>Business</a></li><li><a href=/categories/case-studies/>Case Studies</a></li><li><a href=/categories/software/>Software</a></li></ul></div><div class="widget widget-tag"><h4 class=widget-title>Tags</h4><ul class=widget-tag-list><li><a href=/tags/change-management/>Change Management</a></li><li><a href=/tags/economics/>Economics</a></li><li><a href=/tags/finance/>Finance</a></li><li><a href=/tags/java/>Java</a></li><li><a href=/tags/refactoring/>Refactoring</a></li><li><a href=/tags/social-entrepreneurship/>Social Entrepreneurship</a></li><li><a href=/tags/software-design/>Software Design</a></li><li><a href=/tags/software-testing/>Software Testing</a></li></ul></div></aside></div></div></div></section><footer class=footer><div class=container><div class=row><div class=col-md-12><div class=footer-menu><ul><li><a href=/>Home</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Articles</a></li></ul></div><div class=footer-menu><ul><li><a href=https://www.linkedin.com/in/nadia-humbert-labeaumaz/ target=_blank><i class=ion-social-linkedin-outline></i></a></li><li><a href=https://github.com/nphumbert target=_blank><i class=ion-social-github-outline></i></a></li><li><a href=https://twitter.com/nphumbert target=_blank><i class=ion-social-twitter-outline></i></a></li></ul></div><p class=copyright></p></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script><script src=/plugins/bootstrap/js/bootstrap.min.js></script><script src=/plugins/slick/slick.min.js></script><script src=/plugins/magnific-popup/magnific-popup.min.js></script><script src=/plugins/shuffle/shuffle.min.js></script><script src=/plugins/google-map/gmap.js defer></script><script src=/js/script.min.js></script></body></html>