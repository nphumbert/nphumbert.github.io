<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Entrepreneur, consultant, bio-sciences and software engineer."><meta name=author content="Nadia Humbert-Labeaumaz"><meta name=generator content="Hugo 0.131.0"><meta property="og:image" content="https://nphumbert.github.io/images/blog/circuit-breaker/header.jpg"><meta property="og:url" content="https://nphumbert.github.io/blog/2017/07/23/setup-a-circuit-breaker-with-hystrix/"><meta property="og:site_name" content="Nadia Humbert-Labeaumaz"><meta property="og:title" content="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"><meta property="og:description" content="In a microservices architecture, several things could go wrong. For example, a middleware, the network or the service you want to contact could be down. In this world of uncertainty, you have to anticipate problems to avoid breaking the entire chain and throwing an error to the end-user when you could offer a partially degraded service instead.
This article aims to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-07-23T13:33:38+02:00"><meta property="article:modified_time" content="2017-07-23T13:33:38+02:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="Software Design"><meta property="og:image" content="https://nphumbert.github.io/images/slider.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nphumbert.github.io/images/slider.jpg"><meta name=twitter:title content="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"><meta name=twitter:description content="In a microservices architecture, several things could go wrong. For example, a middleware, the network or the service you want to contact could be down. In this world of uncertainty, you have to anticipate problems to avoid breaking the entire chain and throwing an error to the end-user when you could offer a partially degraded service instead.
This article aims to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot."><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDXGPB3FE3"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FDXGPB3FE3")}</script><link rel=stylesheet href=/plugins/bootstrap/css/bootstrap.min.css media=screen><link rel=stylesheet href=/plugins/ionicons/css/ionicons.min.css><link rel=stylesheet href=/plugins/magnific-popup/magnific-popup.min.css><link rel=stylesheet href=/plugins/slick/slick.css><link rel=stylesheet href=/scss/style.min.css media=screen><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=icon href=/images/favicon.png type=image/x-icon><link rel=canonical href=https://nphumbert.github.io/blog/2017/07/23/setup-a-circuit-breaker-with-hystrix/></head><body><div class=preloader></div><header class=navigation><div class=container><div class=row><div class=col-md-12><nav class=navbar><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navigation>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse" id=navigation><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Articles</a></li></ul></div></nav></div></div></div></header><section class="page-title bg-2" style=background-image:url(/images/blog/circuit-breaker/header.jpg)><div class=container><div class=row><div class=col-md-12><div class=block><h1>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</h1><p></p></div></div></div></div></section><section class=page-wrapper><div class=container><div class=row><div class=col-md-8><div class="post post-single"><h2 class=post-title>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</h2><div class=post-meta><ul><li><i class=ion-calendar></i> July 23, 2017</li><li><i class=ion-android-people></i>
Posted by
<a class=text-primary href=/author/nadia-humbert-labeaumaz>Nadia Humbert-Labeaumaz</a></li><li><i class=ion-pricetags></i>
<a href=/tags/java>Java</a>, <a href=/tags/software-design>Software Design</a></li></ul></div><div class=post-thumb><img class=img-responsive src=/images/blog/circuit-breaker/header.jpg alt="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"></div><div class="post-content post-excerpt"><p>In a microservices architecture, several things could go wrong. For example, a middleware, the network or the service you want to contact could be down. In this world of uncertainty, you have to anticipate problems to avoid breaking the entire chain and throwing an error to the end-user when you could offer a partially degraded service instead.</p><p>This article aims to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot.</p><h2 id=feign-client-crash-course>Feign Client Crash Course</h2><p><a href=https://github.com/OpenFeign/feign>Feign</a> is an HTTP client created by Netflix to make HTTP communications easier. It is integrated into Spring Boot with the <code>spring-cloud-starter-feign</code> starter.</p><p>To create a client to consume an HTTP service, creating an interface annotated with <code>@FeignClient</code> is necessary. Endpoints can be declared in this interface using an API close to the Spring MVC API. It is also required to add The <code>@EnableFeignClients</code> annotation to a Spring Configuration class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span>, url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span>)
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span>(<span style=color:#a6e22e>@RequestBody</span> ViewingHistory history);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>An instance of <code>VideoClient</code> is automagically injected into the Spring application context and can be autowired and used throughout the application. Moreover, if the <code>videos</code> microservice is registered to the same discovery service as the current microservice, there is no need for an URL as it will be retrieved for you based on the <code>name</code>.</p><p>If the <code>videos</code> service, a middleware or the network happens to be down or overloaded, the <code>suggest</code> method will throw a <code>FeignException</code> that will be propagated throughout the stack if not caught.</p><h2 id=create-a-fallback-implementation>Create a Fallback Implementation</h2><p>Fortunately, Spring Cloud comes with a solution to this problem: a circuit breaker. In this article, we will use <a href=https://github.com/Netflix/Hystrix>Hystrix</a>. It was also created by Netflix and also integrated into Spring Boot using the <code>spring-cloud-starter-hystrix</code> starter.</p><p>The idea is to create an implementation of the <code>VideoClient</code> and mark it as the default behaviour if <code>videos</code> is unreachable or overloaded. Like a lot of other Spring features, it is enabled using an annotation: <code>@EnableCircuitBreaker</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableCircuitBreaker</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span>, url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span>, fallback <span style=color:#f92672>=</span> VideoClientFallback.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span>)
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span>(<span style=color:#a6e22e>@RequestBody</span> ViewingHistory history);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallback</span> <span style=color:#66d9ef>implements</span> VideoClient {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span>(ViewingHistory history) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Degraded service: no suggestion to offer</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A configuration property has to be added to the <code>application.yml</code> file of the Spring Boot application to tell Feign to enable Hystrix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>feign</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>hystrix</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Voil√†! Whenever the remote service is unavailable, the <code>suggest</code> method of the <code>VideoClientFallback</code> will be called, and the end-user will not get an error violently thrown at her.</p><h2 id=keep-track-of-the-source-error>Keep Track of the Source Error</h2><p>With this setup, the fallback will be called regardless of the initial error. If you want to retrieve this error and do something with it, you can use a <code>FallbackFactory</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span>, url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span>, fallbackFactory <span style=color:#f92672>=</span> VideoClientFallbackFactory.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@PostMapping</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span>)
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span>(<span style=color:#a6e22e>@RequestBody</span> ViewingHistory history);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallbackFactory</span> <span style=color:#66d9ef>implements</span> FallbackFactory<span style=color:#f92672>&lt;</span>VideoClient<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> VideoClient <span style=color:#a6e22e>create</span>(Throwable throwable) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> VideoClientFallback(throwable);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallback</span> <span style=color:#66d9ef>implements</span> VideoClient {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Throwable cause;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>VideoClientFallback</span>(Throwable cause) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cause</span> <span style=color:#f92672>=</span> cause;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span>(ViewingHistory history) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (cause <span style=color:#66d9ef>instanceof</span> FeignException <span style=color:#f92672>&amp;&amp;</span> ((FeignException) cause).<span style=color:#a6e22e>status</span>() <span style=color:#f92672>==</span> 404) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Treat the HTTP 404 status</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Microservices foster low coupling between components and resiliency. Hence, throwing an error every time a middleware or service is down would be unfortunate. The circuit breaker pattern explained in this article allows you to ensure the continuity of service. As often, Spring Boot is a great help to set up this mechanism readily.</p></div><div class=post-comments></div></div></div><div class=col-md-4><aside class=sidebar><div class="widget widget-latest-post"><h4 class=widget-title>Latest Posts</h4><div class=media><a class=pull-left href=/blog/2021/04/28/effecting-long-lasting-changes/><img class=media-object src=/images/blog/effecting-long-lasting-changes/header.jpg alt="How to Effect Long-Lasting Organisational Changes"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/04/28/effecting-long-lasting-changes/>How to Effect Long-Lasting Organisational Changes</a></h4></div></div><div class=media><a class=pull-left href=/blog/2021/01/14/what-is-a-social-entrepreneur/><img class=media-object src=/images/blog/what-is-a-social-entrepreneur/header.jpg alt="What is a Social Entrepreneur?"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/01/14/what-is-a-social-entrepreneur/>What is a Social Entrepreneur?</a></h4></div></div><div class=media><a class=pull-left href=/blog/2020/07/05/debt-sme-nz/><img class=media-object src=/images/blog/debt-sme-nz/header.jpg alt="Debt and SMEs in New Zealand"></a><div class=media-body><h4 class=media-heading><a href=/blog/2020/07/05/debt-sme-nz/>Debt and SMEs in New Zealand</a></h4></div></div><div class=media><a class=pull-left href=/blog/2019/06/27/cloudy-relationship-france-diesel/><img class=media-object src=/images/blog/diesel/header.jpg alt="The Cloudy Relationship Between France and Diesel"></a><div class=media-body><h4 class=media-heading><a href=/blog/2019/06/27/cloudy-relationship-france-diesel/>The Cloudy Relationship Between France and Diesel</a></h4></div></div></div><div class="widget widget-category"><h4 class=widget-title>Categories</h4><ul class=widget-category-list><li><a href=/categories/business/>Business</a></li><li><a href=/categories/case-studies/>Case Studies</a></li><li><a href=/categories/software/>Software</a></li></ul></div><div class="widget widget-tag"><h4 class=widget-title>Tags</h4><ul class=widget-tag-list><li><a href=/tags/change-management/>Change Management</a></li><li><a href=/tags/economics/>Economics</a></li><li><a href=/tags/finance/>Finance</a></li><li><a href=/tags/java/>Java</a></li><li><a href=/tags/refactoring/>Refactoring</a></li><li><a href=/tags/social-entrepreneurship/>Social Entrepreneurship</a></li><li><a href=/tags/software-design/>Software Design</a></li><li><a href=/tags/software-testing/>Software Testing</a></li></ul></div></aside></div></div></div></section><footer class=footer><div class=container><div class=row><div class=col-md-12><div class=footer-menu><ul><li><a href=/>Home</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Articles</a></li></ul></div><div class=footer-menu><ul><li><a href=https://www.linkedin.com/in/nadia-humbert-labeaumaz/ target=_blank><i class=ion-social-linkedin-outline></i></a></li><li><a href=https://github.com/nphumbert target=_blank><i class=ion-social-github-outline></i></a></li><li><a href=https://twitter.com/nphumbert target=_blank><i class=ion-social-twitter-outline></i></a></li></ul></div><p class=copyright></p></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script><script src=/plugins/bootstrap/js/bootstrap.min.js></script><script src=/plugins/slick/slick.min.js></script><script src=/plugins/magnific-popup/magnific-popup.min.js></script><script src=/plugins/shuffle/shuffle.min.js></script><script src=/plugins/google-map/gmap.js defer></script><script src=/js/script.min.js></script></body></html>